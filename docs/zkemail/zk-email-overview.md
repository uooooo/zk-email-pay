# zkEmail 教科書（日本語版 / 企画・設計者向け）

バージョン: 0.1（ドラフト）

このドキュメントは、メールを暗号学的に証明可能な命令ソースとして扱う「zkEmail」の基礎から設計・実装上の判断ポイントまでを体系的にまとめた教科書です。実装コードは含みません。プロダクト企画、スマートコントラクト設計、証明系の要件整理に役立ててください。あわせて ZK Email SDK（Blueprint/Registry）と Email Wallet（回路/コントラクト/リレーヤー）の具体的な活用パスも概説します。

## 1. はじめに
- 目的: メールの送信事実・内容整合性をゼロ知識証明（ZK）で検証し、オンチェーン動作（送金/承認等）に安全に結びつける。
- 動機: ウォレットアドレスの共有やガス・鍵管理は一般ユーザーに高い摩擦。ユーザーが慣れた「メール」を起点に、安全な資産操作を可能にする。
- スコープ: DKIM中心のメール正当性検証をZK化。SPF/DMARCは補助的扱い。DNSSECやAA（アカウントアブストラクション）との連携モデルも概説。

## 2. メールの基礎（ZK化に必要な要点）
- 送受信: SMTPで配送、メッセージはヘッダ＋本文（MIME）。
- 認証技術:
  - SPF: 送信IPの正当性（ヘッダ改ざん耐性は限定的）。
  - DKIM: 送信ドメインが公開鍵で署名。ヘッダの一部と本文ハッシュを対象に署名。
  - DMARC: SPF/DKIMの整合性ポリシー。
- DKIMの要点:
  - `DKIM-Signature`ヘッダに、署名アルゴリズム（例: rsa-sha256）、選択子`(s=)`、ドメイン`(d=)`、対象ヘッダリスト`(h=)`、本文ハッシュ`(bh=)`、署名`(b=)`等が入る。
  - 署名鍵はDNSの`<selector>._domainkey.<domain>` TXTに公開。
  - ヘッダ/本文は「canonicalization（単純 or relaxed）」規則で正規化した上でハッシュ・署名。
  - 実務要点: 実装ではヘッダ長・本文長の上限を定めて証明コストを制御（例: ヘッダ最大長は64の倍数）。本文検証を省略する「Skip body hash」最適化も可能（ヘッダのみで十分な場合）。

## 3. zkEmail の目標と要件
- 目標:
  - 真正性: 正当なドメインから送信された特定内容のメールであることを証明。
  - 完整性: 指定フィールド（例: From, To, Subject, Date, Amount, Token 等）の整合性。
  - 最小開示: メールの必要最小限のみ公開、本文全体は非開示。
  - オンチェーン結合: 証明の検証でスマコンが安全に状態遷移できる。
- 非目標（MVP）: 全メール機能のZK化、全文保存/復号、複雑なMIME処理。

補足: Proton Mail のように本文の原文取得が制限されるプロバイダでは、レジストリ/SDKのうち「本文を使う検証」は制約されます（本文を使わない設計は可）。

## 4. 参照アーキテクチャ
- クライアント: メール作成/受取UI、命令テンプレ生成、必要に応じローカルで証明補助。
- プルーバ（Prover）: 生メール（orヘッダ＋必要断片）からZK証明を生成。
- リレー/Paymaster: 証明を添えてトランザクション送信、ガス抽象化。
- 検証コントラクト: 証明検証＋ビジネスロジック（送金/承認/ミント等）。
- キー取得サービス: DKIM公開鍵をDNSから取得（信頼モデルは後述）。

データ流れ（例）:
1) 送信者が定型の「支払い命令メール」を送る。
2) 受取側またはサービスがメールを取得し、DKIM情報を抽出。
3) ZK回路で「このメールは特定ドメインからの正当な署名で、命令スキーマに一致」と証明。
4) 証明＋公開入力をスマコンへ→検証成功で送金/承認。

実装パス:
- Email Wallet を用いる（推奨のフルパッケージ）
  - 既製の circom 回路群、Verifier コントラクト、Core/Handlers、Relayer/Prover を利用。
- ZK Email SDK（Blueprint/Registry）を用いる（カスタム証明）
  - レジストリに正規表現（Decomposed Regex）やヘッダ/本文制約を登録→自動で回路コンパイル/Verifier用意。
- 自作回路/コントラクトで統合（高度）
  - DKIM検証・正規化・抽出ロジックを独自に実装し、検証器を自前でデプロイ。

## 5. DKIM検証のZK化
- 入力と出力（概念）:
  - 秘密入力: 正規化済みヘッダ断片、本文ハッシュ対象部分、署名値`b`、選択的に本文の一部。
  - 公開入力: ドメイン`d`、選択子`sel`、許容ヘッダ集合、金額/トークン/宛先など命令要件、期限`expiry`、ノンス`nonce` 等。
  - 検証鍵: DNSから得た公開鍵`(n, e)`（RSA）またはEd25519公開鍵。
- カノニカライゼーション:
  - ヘッダ: `simple`/`relaxed`（余分な空白の折り畳み等）。
  - 本文: `simple`/`relaxed`（末尾改行の正規化等）。`bh`は本文ハッシュのBase64。
- 署名検証:
  - RSAの場合: `m = RSAVerify(b, e, n)`が`EMSA-PKCS1-v1_5(SHA-256, signed_header)`に一致。
  - Ed25519-DKIM（対応ドメイン限定）: EdDSA検証（よりZK向き）。
- キー取得の信頼モデル:
  1) 信頼済みフェッチャ: サーバがDNSから取得し、その値を公開入力に固定（最小構成、MITM耐性はDNSに依存）。
  2) DNSSECアンカー: DNSSECの証明連鎖 or ENS DNSSECオラクルで公開鍵の正当性をオンチェーン/オフチェーンで担保。
 3) 送信ドメイン許可制: 事前登録したドメインの鍵のみ受理（企業ユース向け）。

実装の落とし穴:
- 正規化の差異: ライブラリ間差異でハッシュ不一致が起きやすい。テスト用の生ヘッダ断片と期待ハッシュを固定し、回路・オフチェーン実装の両方で照合する。
- ヘッダ対象リスト`h=`の順序/重複/折返し: RFC準拠の折返し・空白畳みを再現。
- 入力サイズ: 余剰に大きい上限は証明生成時間を悪化させるため、実観測に基づいて調整。

## 6. ZK回路設計の要点
- 公開入力（例）:
  - 送信ドメイン`d`、選択子`sel`、対象ヘッダのリスト/順序、命令の要約（例: `hash(to|amount|token|expiry|nonce)`）、有効期限、プロトコルバージョン。
- 秘密入力（例）:
  - 正規化ヘッダ連結、本文ハッシュ対象、`DKIM-Signature`の`b`、`bh`、解析済みフィールド値。
- 制約:
  - ヘッダ正規化手順の再現（ASCII/空白折り畳み、改行、順序保持）。
  - `bh` = SHA-256(canonicalized_body) を満たす。
  - 署名`b`が選択アルゴリズム（例: rsa-sha256）に従って有効。
  - メールの`From`ドメインと`d=`の関係（DMARC的整合性）を必要に応じて縛る。
  - 命令スキーマの合致（amount/token/to/expiry/nonce など）。
- ハッシュ/署名のコスト:
  - SHA-256やRSAはSNARKで高コスト。MVPは入力サイズを極小化、ヘッダ限定、本文は`bh`のみ参照。
  - Ed25519対応ドメインなら大幅軽量化可。
- リカーシブ証明:
  - 大きな証明を段階化（DKIM検証→命令整合→最終証明）で検証器を軽く保つ選択肢。

Email Wallet 既製回路（要点）:
- `account_creation.circom`: email_addr + relayer_rand + account_key からアカウント生成コミットを作る。
- `account_init.circom`: 招待メール（DKIM/RSA）を検証し、アカウント初期化に必要なインスタンスを出力。
- `email_sender.circom`: ユーザーの返信メール（件名/受取人/タイムスタンプ）を検証、メールアドレス秘匿のまま命令実行に結び付け。
- `claim.circom`: Unclaimed資産/状態の受け取りを検証（email_addr_commit と一致）。
- これらは Verifier コントラクト群と連動し、Core/Handlers から呼び出される。

## 7. 設計パターン（命令エンコード）
- メール命令テンプレ（例）:
  - 件名: `Pay` または `Request`
  - 本文（構造化）:
    ```
    to: user@example.com
    amount: 25.00
    token: USDC
    expiry: 2025-12-31T23:59:59Z
    nonce: 0x... (unique)
    purpose: invoice-#12345
    ```
- 回路では上記本文のキー/バリューの抽出・整合を行い、不要部分は非開示。
- 再放送防止:
  - `nonce` と `expiry` を公開入力に含め、スマコン側でユニーク管理。
- 上限/2FA:
  - 高額しきい値は追加の2FA証明（TOTP/FIDOを別回路/署名で）。

Email Wallet の件名/コマンド例:
- 送金: `Send 10 USDC to friend@domain.com`（宛先メールはコミットで秘匿）
- コントラクト実行: `Execute 0x...`
- 拡張: `Install extension Uniswap`, `Swap 1 DAI to ETH` など。

## 8. 脅威モデルと対策
- 攻撃シナリオ:
  - メール乗っ取り: 正当な送信者が悪用される可能性→高額は二段階承認、上限・遅延解除。
  - DKIM鍵のすり替え: DNS改ざん→DNSSEC/許可ドメイン/鍵ピン留めで軽減。
  - パース差異: 実装差で正規化結果が異なる→仕様準拠テストと厳密な正規化。
  - リプレイ: `nonce`と有効期限、オンチェーンでの消費記録。
  - フィッシング: 明示的なトラストUI（送信ドメイン、金額、目的を強調）。
- ログ/監査:
  - 証明に含めた要約（ドメイン、選択子、命令ハッシュ、タイムスタンプ）をオンチェーンにイベント記録。

運用観点:
- レート制御（メール/IP/トークン別）、ジョブキュー、DLQ。
- DKIM鍵のピン/キャッシュ、ローテーション監視。
- メールのフィッシング耐性（短命/単回のマジックリンク、明示ドメイン）。

## 9. MVP実装戦略（方針）
- 対応ドメインを限定（Gmail等のrsa-sha256/2048）し、本文は最小構造化部分のみ扱う。
- キー取得は当面「信頼済みフェッチャ」モデル＋定期的な鍵キャッシュ、後にDNSSECモデルへ拡張。
- スマコンは1チェーン・1通貨（USDC）・小額ガスレスで開始。
- UXは「1クリック受取」「明確な上限・警告」「エラー理由の可視化」を徹底。

具体パス（推奨）:
- チェーン: Base / OP Stack L2。
- Email Wallet を起動（Sepolia/Base Sepolia）→ Relayer/Prover をDockerで立てる。
- 招待/返信メールのテンプレ確立（件名キーワード、`accountKey` 埋め込み）。
- Unclaimed → Claim パターンで取消/期限を整備。

## 10. 法務・コンプライアンス考慮
- 取引モニタリングと制裁リスト照合（オフチェーン）。
- 限度額・KYCレベル（小額L1、事業者/高額L2）。
- 国別の提供範囲と税務連携の方針。

## 11. 代表的ユースケース
- メール送金/受取（P2P）。
- インボイス請求→自動照合（SMB）。
- 事業者の一括ペイアウト（ギグ/リワード）。
- サインイン/承認メールをZK化してオンチェーン権限に反映。

## 12. 付録
### 12.1 DKIMフィールドの要点
- `d=`: 署名ドメイン。`From:`のドメイン整合性を検討。
- `s=`: セレクタ（DNSで鍵を引く）。
- `a=`: アルゴリズム（例: rsa-sha256）。
- `c=`: 正規化方式（header/body）。
- `h=`: 対象ヘッダリスト（順序重要）。
- `bh=`: 本文ハッシュ（Base64）。
- `b=`: 署名（Base64）。

### 12.2 生メール断片（概念例）
```
From: alice@example.com
To: pay@wallet.xyz
Subject: Pay
Date: Tue, 27 Aug 2025 10:00:00 +0900
DKIM-Signature: v=1; a=rsa-sha256; d=example.com; s=sel1; c=relaxed/simple; h=from:to:subject:date; bh=...; b=...

amount: 25.00
token: USDC
to: bob@example.com
expiry: 2025-12-31T23:59:59Z
nonce: 0xabc123...
```

### 12.3 検証コントラクトの入力ABI（例）
- `publicInputs`:
  - `domainHash`（`d`のハッシュ）、`selectorHash`、`commandCommitment`（命令要約）、`expiry`, `nonce` 等。
- `proof`: ZK証明（Groth16/Plonk/…）。
- `verify(proof, publicInputs) -> bool` が `true` であればビジネスロジック実行。

### 12.4 プルーバ擬似フロー
1) 生メール取得→ヘッダ/本文を正規化。
2) DKIMの`h`リストに従い署名対象ヘッダを連結、本文の`bh`を計算。
3) DNSから公開鍵を取得（信頼モデルに応じて保全）。
4) 回路に入力（公開/秘密）を割り当てて証明生成。
5) 証明＋公開入力をリレー経由でスマコンへ提出。

### 12.5 ZK Email SDK（Blueprint/Registry）の要点
- Blueprint: メールの抽出パターン（Decomposed Regex）、ヘッダ/本文長、送信ドメインなどのパラメータ集合。
- Registry: Blueprint を受け取り回路をコンパイル、オンチェーン Verifier を用意。SDK から「生成→検証」を簡略化。
- Decomposed Regex 制約: 先頭は `(\r\n|^)` を推奨、貪欲/遅延や lookaround は不可、受理状態は一意等。
- .EML の取得: Gmail/Apple Mail/Outlook 等でエクスポートしてテスト。

### 12.6 Relayer/Prover 概観（Email Wallet 準拠）
- Relayer: IMAP 受信→Prover へ入力生成→証明受領→コントラクト呼出→通知送信。DB にアカウント/ジョブ/メールログ。
- Prover: `snarkjs` 等で証明生成（ローカル/Modal）。環境に応じてスケール。
- 設定: `CORE_CONTRACT_ADDRESS`, `PROVER_ADDRESS`, `IMAP/SMTP`, `DATABASE_URL`, `FEE_PER_GAS` など。

---
この教科書はドラフトです。要件や対象ドメイン、鍵取得の信頼モデルが固まり次第、より具体的な仕様に落とし込みます。
